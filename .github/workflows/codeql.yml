# å¯¹äºå¤§å¤šæ•°é¡¹ç›®ï¼Œæ­¤å·¥ä½œæµæ–‡ä»¶æ— éœ€æ›´æ”¹ï¼›åªéœ€æäº¤åˆ°æ‚¨çš„ä»“åº“å³å¯ã€‚
#
# æ‚¨å¯ä»¥æ ¹æ®éœ€è¦ä¿®æ”¹æ­¤æ–‡ä»¶ï¼Œä»¥è¦†ç›–åˆ†æçš„è¯­è¨€é›†ï¼Œæˆ–æä¾›è‡ªå®šä¹‰æŸ¥è¯¢æˆ–æ„å»ºé€»è¾‘ã€‚
#
# ******** æ³¨æ„ ********
# æˆ‘ä»¬å·²å°è¯•æ£€æµ‹æ‚¨çš„ä»“åº“ä¸­çš„è¯­è¨€ã€‚è¯·æ£€æŸ¥ä¸‹é¢å®šä¹‰çš„ `language` çŸ©é˜µï¼Œç¡®ä¿åŒ…å«äº†æ‰€æœ‰å—æ”¯æŒçš„ CodeQL è¯­è¨€ã€‚
name: "CodeQL Advanced"
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    - cron: '23 5 * * 2'
  workflow_dispatch:
jobs:
  analyze:
    name: Analyze (${{ matrix.language }})
    # Runner çš„è§„æ ¼ä¼šå½±å“ CodeQL åˆ†ææ—¶é—´ã€‚è¯¦æƒ…è¯·å‚é˜…ï¼š
    #   - https://gh.io/recommended-hardware-resources-for-running-codeql
    #   - https://gh.io/supported-runners-and-hardware-resources
    #   - https://gh.io/using-larger-runners (ä»…é™ GitHub.com)
    # å»ºè®®ä½¿ç”¨æ›´é«˜è§„æ ¼çš„ Runner æˆ–æ›´å¤§èµ„æºçš„æœºå™¨ä»¥æå‡åˆ†æé€Ÿåº¦ã€‚
    runs-on: ${{ (matrix.language == 'swift' && 'macos-latest') || 'ubuntu-latest' }}
    permissions:
      # æ‰€æœ‰å·¥ä½œæµéƒ½éœ€è¦
      security-events: write
      # è·å–å†…éƒ¨æˆ–ç§æœ‰ CodeQL åŒ…æ—¶éœ€è¦
      packages: read
      # ä»…ç§æœ‰ä»“åº“å·¥ä½œæµéœ€è¦
      actions: read
      contents: read
    strategy:
      fail-fast: false
      matrix:
        include:
        - language: actions
          build-mode: none
        - language: javascript-typescript
          build-mode: none
        - language: python
          build-mode: none
        - language: java-kotlin
          build-mode: none
        # CodeQL æ”¯æŒä»¥ä¸‹ 'language' å…³é”®å­—ï¼š'actions', 'c-cpp', 'csharp', 'go', 'java-kotlin', 'javascript-typescript', 'python', 'ruby', 'rust', 'swift'
        # ä½¿ç”¨ `c-cpp` å¯åˆ†æ Cã€C++ æˆ–ä¸¤è€…çš„ä»£ç 
        # ä½¿ç”¨ 'java-kotlin' å¯åˆ†æ Javaã€Kotlin æˆ–ä¸¤è€…çš„ä»£ç 
        # ä½¿ç”¨ 'javascript-typescript' å¯åˆ†æ JavaScriptã€TypeScript æˆ–ä¸¤è€…çš„ä»£ç 
        # äº†è§£å¦‚ä½•æ›´æ”¹åˆ†æè¯­è¨€æˆ–è‡ªå®šä¹‰åˆ†ææ¨¡å¼ï¼Œè¯·å‚é˜…ï¼š
        # https://docs.github.com/en/code-security/code-scanning/creating-an-advanced-setup-for-code-scanning/customizing-your-advanced-setup-for-code-scanning
        # å¦‚æœåˆ†æç¼–è¯‘å‹è¯­è¨€ï¼Œå¯ä¿®æ”¹ 'build-mode' ä»¥è‡ªå®šä¹‰åˆ†ææ–¹å¼ï¼Œè¯¦è§ï¼š
        # https://docs.github.com/en/code-security/code-scanning/creating-an-advanced-setup-for-code-scanning/codeql-code-scanning-for-compiled-languages
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    # åœ¨è¿è¡Œ `github/codeql-action/init` ä¹‹å‰å¯æ·»åŠ ä»»ä½•è®¾ç½®æ­¥éª¤ã€‚
    # åŒ…æ‹¬å®‰è£…ç¼–è¯‘å™¨æˆ–è¿è¡Œç¯å¢ƒï¼ˆå¦‚ `actions/setup-node` ç­‰ï¼‰ã€‚é€šå¸¸ä»…æ‰‹åŠ¨æ„å»ºæ—¶éœ€è¦ã€‚
    # - name: Setup runtime (ç¤ºä¾‹)
    #   uses: actions/setup-example@v1
    # åˆå§‹åŒ– CodeQL å·¥å…·ä»¥è¿›è¡Œæ‰«æã€‚
    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: ${{ matrix.language }}
        build-mode: ${{ matrix.build-mode }}
        # å¦‚éœ€æŒ‡å®šè‡ªå®šä¹‰æŸ¥è¯¢ï¼Œå¯åœ¨æ­¤å¤„æˆ–é…ç½®æ–‡ä»¶ä¸­è®¾ç½®ã€‚
        # é»˜è®¤æƒ…å†µä¸‹ï¼Œæ­¤å¤„åˆ—å‡ºçš„æŸ¥è¯¢ä¼šè¦†ç›–é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šçš„æŸ¥è¯¢ã€‚
        # åœ¨åˆ—è¡¨å‰åŠ  "+" å¯åŒæ—¶ä½¿ç”¨æ­¤å¤„å’Œé…ç½®æ–‡ä»¶ä¸­çš„æŸ¥è¯¢ã€‚
        # æ›´å¤š CodeQL æŸ¥è¯¢åŒ…è¯¦æƒ…è¯·å‚é˜…ï¼š
        # https://docs.github.com/en/code-security/code-scanning/automatically-scanning-your-code-for-vulnerabilities-and-errors/configuring-code-scanning#using-queries-in-ql-packs
        # queries: security-extended,security-and-quality
    # å¦‚æœæŸç§è¯­è¨€çš„ analyze æ­¥éª¤å¤±è´¥ï¼Œæç¤ºâ€œæ— æ³•è‡ªåŠ¨æ„å»ºæ‚¨çš„ä»£ç â€ï¼Œè¯·åœ¨ä¸Šæ–¹çŸ©é˜µä¸­å°†è¯¥è¯­è¨€çš„ build-mode è®¾ç½®ä¸º "manual"ï¼Œå¹¶åœ¨æ­¤æ­¥éª¤ä¸­æ·»åŠ æ„å»ºå‘½ä»¤ã€‚
    # â„¹ï¸ å¯ä½¿ç”¨æ“ä½œç³»ç»Ÿ shell è¿è¡Œå‘½ä»¤è¡Œç¨‹åºã€‚
    # ğŸ“š è¯¦è§ https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#jobsjob_idstepsrun
    - if: matrix.build-mode == 'manual'
      shell: bash
      run: |
        echo 'å¦‚æœæ‚¨ä¸ºä¸€ç§æˆ–å¤šç§è¯­è¨€ä½¿ç”¨äº† "manual" æ„å»ºæ¨¡å¼ï¼Œè¯·åœ¨æ­¤å¤„æ›¿æ¢ä¸ºæ‚¨çš„æ„å»ºå‘½ä»¤ï¼Œä¾‹å¦‚ï¼š'
        echo '  make bootstrap'
        echo '  make release'
        exit 1
    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      with:
        category: "/language:${{matrix.language}}"

